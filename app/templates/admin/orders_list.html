{% extends "admin.layout.html" %}
{% import "macros/pagination.html" as ps %}

{% set _lang = (lang or (i18n.lang if i18n is defined and i18n.lang else 'ko')) %}
{% set ctx = ctx or {} %}
{% set filters = ctx.filters or {} %}
{% set sort = ctx.sort or {'field':'created_at_utc','dir':'desc'} %}
{% set page = ctx.page or {'page':1,'size':20,'total':0} %}
{% set items = ctx.items or [] %}
{% set DEFAULT_PAGE_SIZE = 20 %}

{% block head %}
<style>
    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:flex-end;margin-bottom:12px}
    .toolbar .field{display:flex;flex-direction:column;gap:4px}
    .toolbar .field input,.toolbar .field select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--fg)}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
    .table th{font-weight:700;color:var(--muted)}
    .table tr:hover{background:rgba(0,0,0,.04)}
    .badge{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
    .status-created{background:#f2f2f6}
    .status-awaiting_deposit{background:#fff7e6}
    .status-paid{background:#e6fff1}
    .status-canceled{background:#f9e6e6}
    .status-expired{background:#f3e6ff}
    .row-warn{outline:2px dashed #e3a008;outline-offset:-2px}
    .actions{display:flex;gap:6px}
    .btn-sm{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--fg);cursor:pointer}
    .btn-sm[disabled]{opacity:.5;cursor:not-allowed}
    .drawer{position:fixed;top:0;right:-480px;width:480px;max-width:-4px 0 24px rgba(0,0,0,.2);transition:right .25s ease;z-index:9997;display:flex;flex-direction:column}
    .drawer.is-open{right:0}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .drawer-body{padding:12px 14px;overflow:auto;flex:1}
    .meta{display:grid;grid-template-columns:120px 1fr;gap:6px 10px;margin:12px 0}
    .timeline{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .timeline li{border-left:3px solid var(--border);padding-left:10px}
    .pill{display:inline-flex;gap:6px;align-items:center}
</style>
{% endblock %}

{% block content %}
<h1 style="margin:6px 0 12px">{{ '주문' if _lang=='ko' else 'Orders' }}</h1>

<form class="toolbar" method="get" action="">
    <div class="field">
        <label for="q">{{ '검색' if _lang=='ko' else 'Search' }}</label>
        <input id="q" name="q" type="text" value="{{ filters.q or '' }}" placeholder="{{ '코드/이름/이메일/전화' if _lang=='ko' else 'Code/Name/Email/Phone' }}">
    </div>
    <div class="field">
        <label for="status">{{ '상태' if _lang=='ko' else 'Status' }}</label>
        <select id="status" name="status">
            {%- set st = filters.status or '' -%}
            <option value="">{{ '전체' if _lang=='ko' else 'All' }}</option>
            {% for s in ['created','awaiting_deposit','paid','canceled','expired'] %}
                <option value="{{ s }}" {{ 'selected' if st==s else '' }}>{{ s }}</option> 
            {% endfor %}
        </select>
    </div>
    <div class="field">
        <label for="date_from">{{ '시작일(KST)' if _lang=='ko' else 'From (KST)' }}</label>
        <input id="date_from" name="date_from" type="date" value="{{ filters.date_from or '' }}">
    </div>
    <div class="field">
        <label for="date_to">{{ '종료일(KST)' if _lang=='ko' else 'To (KST)' }}</label>
        <input id="date_to" name="date_to" tabindex="date" value="{{ filters.date_to or '' }}">
    </div>
    <div class="field">
        <label for="sort">{{ '정렬' if _lang=='ko' else 'Sort' }}</label>
        <select id="sort" name="sort">
            {%- set cur_sort = (sort.field ~ ':' ~ sort.dir) if sort else 'created_at_utc:desc' -%}
            {%- set sort_fields = [
                {'value':'created_at_utc:desc','label':('최신 생성' if _lang=='ko' else 'Newest created')},
                {'value':'created_at_utc:asc','label':('오래된 생성' if _lang=='ko' else 'Oldest created')},
                {'value':'expires_at_utc:asc','label':('만료 임박' if _lang=='ko' else 'Expires soon')},
                {'value':'amount_total:desc','label':('금액 높은순' if _lang=='ko' else 'Amount high→low')},
                {'value':'amount_total:asc','label':('금액 낮은순' if _lang=='ko' else 'Amount low→high')},
            ] -%}
            {% for f in sort_fields %}
                <option value="{{ f.value }}" {{ 'selected' if f.value==cur_sort else '' }}>{{ f.label }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="field">
        <label for="size">{{ '페이지당' if _lang=='ko' else 'Per page' }}</label>
        <select id="size" name="size">
            {% for s in [10,20,50,100] %}
                <option value="{{ s }}" {{ 'selected' if (page.size or DEFAULT_PAGE_SIZE)|int == s else '' }}>{{ s }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="field">
        <button class="btn" type="submit" style="height:36px">{{ '적용' if _lang=='ko' else 'Apply' }}</button>
    </div>
</form>

<div class="table-wrap" role="region" aria-label="{{ '주문 목록' if _lang=='ko' else 'Orders list' }}">
    <table class="table">
        <thead>
            <tr>
                <th>{{ '코드' if _lang=='ko' else 'Code' }}</th>
                <th>{{ '상품' if _lang=='ko' else 'Goods' }}</th>
                <th>{{ '고객' if _lang=='ko' else 'Buyer' }}</th>
                <th>{{ '금액' if _lang=='ko' else 'Amount' }}</th>
                <th>{{ '상태' if _lang=='ko' else 'Status' }}</th>
                <th>{{ '만료(KST)' if _lang=='ko' else 'Expires (KST)' }}</th>
                <th>{{ '생성(KST)' if _lang=='ko' else 'Created (KST)' }}</th>
                <th>{{ '액션' if _lang=='ko' else 'Actions' }}</th>
            </tr>
        </thead>
        <tbody id="adm-order-tbody">
            {% for if in items %}
            {% set st = it.status %}
            {% set soon = (it.expires_at_utc is defined and it.expires_at_utc) %}
            <tr class="{{ 'row-warn' if soon eles '' }}" data-id="{{ it.id }}" data-code="{{ it.code }}">
                <td><button class="btn-sm js-open-detail" type="button" aria-label="open {{ it.code }}">{{ it.code }}</button></td>
                <td>{{ it.goods_name_ko }}</td>
                <td>{{ it.buyer_name }}</td>
                <td>{{ (it.amount_total)|int }}</td>
                <td><span class="badge status-{{ st }}">{{ st }}</span></td>
                <td data-kst="{{ it.expires_at_utc or '' }}">{{ it.expires_at_utc or '' }}</td>
                <td data-kst="{{ it.created_at_utc }}">{{ it.created_at_utc }}</td>
                <td class="actions">
                    {# guards: mark_paid only when not paid/canceled/expired #}
                    <button class="btn-sm js-act" data-act="mark_paid" {{ 'disabled' if st in ['paid','canceled','expired'] else '' }}>{{ '입금확인' if _lang=='ko' else 'Mark paid' }}</button>
                    <button class="btn-sm js-act" data-act="expire" {{ 'disabled' if st in ['paid','canceled','expired'] else '' }}>{{ '만료' if _lang=='ko' else 'Expire' }}</button>
                    <button class="btn-sm js-act" data-act="cancel" {{ 'disabled' if st in ['paid','canceled','expired'] else '' }}>{{ '취소' if _lang=='ko' else 'Cancel' }}</button>
                </td>
            </tr>
            {% endfor %}
            {% if items|length == 0 %}
            <tr><td colspan="8">{{ '데이터가 없습니다.' if _lang=='ko' else 'No data.' }}</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>

<div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px">
    <div>{{ page.total|int }} {{ '건' if _lang=='ko' else 'items' }}</div>
    <div>{{ pg.pager({'page':page.page or 1, 'size':page.size or DEFAULT_PAGE_SIZE,'total':page.total or 0,'sort':cur_sort}, request.path, request.args.to_dict()) }}</div>
</div>

<div class="drawer" id="orderDrawer" aria-hidden="true" aria-labelledby="orderDrawerTitle" role="dialog">
    {% include "admin/order_detail.html" %}
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/admin/ordersjs" defer {{ 'nonce=' ~ _csp_nonce if _csp_nonce}}></script>
<script defer {{ 'nonce=' ~ _csp_nonce if _csp_nonce }}>
(function(){
    function fmtKSTAll(){
        var rows=document.querySelectorAll('[data-kst]');
        rows.forEach(function(el){var v=el.getAttribute('data-kst'); el.textContent=v?I18n.formatDateKST(v):'';});
        // Amount column
        document.querySelectorAll('#adm-orders-tbody tr').forEach(function(tr){
            var tds = tr.querySelectorAll('td');
            if (tds[3]){ var raw=Number(tds[3].textContent.trim()||0); tds[3].textContent=I18n.formatCurrencyKRW(raw); }
        });
    }
    if(document.readyState==="complete"||document.readyState==="interactive"){ fmtKSTAll();} else{document.addEventListener('DOMContentLoaded', fmtKSTAll, { once:true }); }
})();
</script>
{% endblock %}
