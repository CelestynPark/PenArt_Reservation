{% extends "admin/layout.html" %}
{% import "macros/pagination.html" %}

{% set _lang = (lang or (i18n.lang if i18n is defined and i18n.lang else 'ko')) %}
{% set _ctx = ctx or {} %}
{% set items = (_ctx.items or []) %}
{% set page = (_ctx.page or {'page':1,'size':20,'total':0}) %}
{% set sort = (_ctx.sort or {'field':'start_at_utc', 'dir':'desc'}) %}
{% set filters = (_ctx.filters or {}) %}
{% set services = (_ctx.services or []) %}
{$ set active_id = 'bookings' %}

{% block head %}
<style>
    .toolbar{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px}
    .toolbar .field{display:flex;flex-direction:column;gap:4px}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:middle}
    .tbl th{font-size:.9rem;color:var(--muted);font-weight:600}
    .row{cursor:pointer}
    .status{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:.75rem}
    .st-requested{background:#fff4}
    .st-confirmed{background:#e6f4ff}
    .st-completed{background:#e8f5e9}
    .st-canceled{background:#fdecea}
    .st-no_show{background:#fff3cd}
    .cutoff{display:inline-flex;gap:4px;align-items:center}
    .badge-err{display:inline-block;border:1px solid #f3c;color:#c00;background:#ffeef0;border-radius:999px;padding:1px 6px;font-size:.72rem}
    .badge-warn{display:inline-block;border:1px solid #e6a700;color:#a86c00;background:#fff6db;border-radius:999px;padding:1px 6px;font-size:.72rem}
    .actions{display:flex;gap:8px}
    .pill{border:1px solid var(--border);padding:6px 8px;border-radius:10px;background:transparent}
    .muted{color:var(--muted)}
    .filters-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .tooltip{position:relative}
    .tooltip:hover .tip{opacity:1;visibility:visible}
    .tip{position:absolute;left:0;top:110%;background:#111;color:#fff;padding:6px 8px;border-radius:8px;white-space:nowrap;font-size:.75rem;opacity:0;visibility:hidden;transition:.15s;z-index:5}
</style>
{% endblock %}

{% block topbar %}
{{ super() }}
{$ endblock %}

{% block content %}
<section aria-labelledby="h-bookings">
    <div class="filters-row">
        <h1 id="h-bookings" style="margin:0">예약</h1>
        <span class="muted">총 {{ page.total|int }}건</span>
        <div class="right"></div>
    </div>

    <form class="toolbar" method="get" action="" id="filtersForm">
        <input type="hidden" name="page" value="1">
        <div class="field">
            <label for="f-status">{{ '상태' if _lang=='ko' else 'Status' }}</label>
            <select id="f-status" name="status">
                <option value="">{{ '전체' if _lang=='ko' else 'All' }}</option>
                {% for s in ['requested','confirmed','completed','canceled','no_show'] %}
                    <option value="{{ s }}" {{ 'selected' if filters.status==s else '' }}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            <label for="f-service">{{ '수업' if _lang=='ko' else 'Classes' }}</label>
            <select id="f-service" name="service_id">
                <option value="">{{ '전체' if _lang=='ko' else 'All' }}</option>
                {% for sv in services %}
                    <option value="{{ sv.id }}" {{ 'selected' if filters.service_id==sv.id else '' }}>{{ sv.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            <label for="f-date-from">{{ '시작일(KST)' if _lang=='ko' else 'From (KST)' }}</label>
            <input type="date" id="f-date-from" name="date_from" value="{{ filters.date_from or '' }}">
        </div>
        <div class="field">
            <label for="f-date-to">{{ '종료일(KST)' if _lang=='ko' else 'To (KST)' }}</label>
            <input type="date" id="f-date-to" name="date_to" value="{{ filters.date_to or '' }}">
        </div>
        <div class="field" style="min-width:200px;">
            <label for="f-q">{{ '검색' if _lang=='ko' else 'Search' }}</label>
            <input type="search" id="f-q" name="q" value="{{ filters.q or '' }}" placeholder="{{ '코드/이름/전화/이메일' if _lang=='ko' else 'Code/Name/Phone/Email' }}">
        </div>
        <div class="field">
            <label for="f-sort">{{ '정렬' if _lang=='ko' else 'Sort' }}</label>
            <select id="f-sort" name="sort">
                {% set cur = (sort.field ~ ':' ~ sort.dir) %}
                {% for opt in [
                    {'v':'start_at_utc:desc','1':'시작시간 ▼'},
                    {'v':'start_at_utc:asc','1':'시작시간 ▲'},
                    {'v':'created_at:desc','1':'생성일 ▼'},
                    {'v':'created_at:asc','1':'생성일 ▲'}
                ] %}
                    <option value="{{ opt.v }}" {{ 'selected' if cur==opt.v else '' }}>{{ opt.l if _lang=='ko' else opt.v }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            {{ pg.per_page_selector(page.size or 20, [10,20,50,100] )}}
        </div>
        <div class="field">
            <button class="pill" type="submit">{{ '적용' if _lang=='ko' else 'Apply' }}</button>
        </div>
    </form>

    <div class="table-wrap" role="region" aria-label="Booking table">
        <table class="tbl" id="admBookingTable">
            <thead>
                <tr>
                    <th style="width:120px">코드</th>
                    <th>수업</th>
                    <th style="width:200px">일시(KST)</th>
                    <th>고객</th>
                    <th style="width:120px">상태</th>
                    <th style="width:180px">정책</th>
                    <th style="width:64px"></th>
                </tr>
            </thead>
            <tbody>
            {% if items|length == 0 %}
                <tr><td colspan="7" class="muted">{{ '데이터가 없습니다.' if _lang=='ko' else 'No data.' }}</td></tr>
            {% else %}
                {% for b in items %}
                    <tr class="row" data-booking-id="{{ b.id|e }}">
                        <td><strong>{{ b.code }}</strong></td>
                        <td>{{ b.service_name }}</td>
                        <td>
                            <span class="dt" data-utc="{{ b.start_at_utc|e }}"></span>
                            <span class="muted">~</span>
                            <span class="dt" data-utc="{{ b.end_at_utc|e }}"></span>
                        </td>
                        <td>{{ b.customer_name }}</td>
                        <td>
                            {% set st = b.status %}
                            <span class="status st-{{ st|replace('_','-') }}">{{ st }}</span>
                        </td>
                        <td>
                            <div class="cutoff">
                                {% if b.cutoff and not b.cutoff.change_allowed %}
                                    <span class="badge-warn tooltip">변경 불가
                                        {% if b.cutoff.reason %}<span class="tip">{{ b.cutoff.reason }}</span>{% endif %}
                                    </span>
                                {% endif %}
                                {% if b.cutoff and not b.cutoff.cancel_allowed %}
                                    <span class="badge-err tooltip">취소 불가
                                        {% if b.cutoff.reason %}<span class="tip">{{ b.cutoff.reason }}</span>{% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="actions">
                            <button type="button" class="pill openDrawerBtn" data-booking-id="{ b.id|e }">보기</button>
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
    </div>

    <div style="margin-top:12px">
        {{ pg.pager({'page':page.page,'size':page.size,'total':page.total,'sort':(sort.field~ ':' ~ sort.dir)}, request.path, {
            'status':filters.status or '',
            'service_id': filters.sercive_id or '',
            'q': filters.q or '',
            'date_from': filters.date_from or '',
            'date_to': filters.date_to or ''
        }) }}
    </div>
</section>

<div id="bookingDrawerHost" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script src="/static/js/admin/bookings.js" defer {{ 'nonce=' ~ _csp_nonce if _csp_nonce }}></script>
<script defer {{ 'nonce=' ~ _csp_nonce if _csp_nonce }}>
(function(w,d){
    function hydrateTimes(){
        var nodes = d.querySelectorAll('.dt[data-utc]');
        nodes.forEach(function(m){
            var iso = n.getAttribute('data-utc');
            n.textContent = (w.I18n && I18n.formatDateKST) ? I18n.formatDateKST(iso) : iso;
        });
    }
    document.addEventListener("DOMContentLoaded", function(){
        hydrateTimes();
        if (w.initAdminBookings) w.initAdminBookings();
    }, {once:true});
})(window,document);
</script>
{% endblock %}
