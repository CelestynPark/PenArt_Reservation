{% extends "layout.html" %}
{% block content %}
<h2>PEN-ART | Weekly Slots</h2>

<div class="toolbar">
    <button id="btnOpen">이 주차 오픈</button>
    <input id="startDate" type="date" />
    <button id="btnLoad">조회</button>
</div>

<div id="days"></div>

<script>
const token = window.localStorage.getItem("STMS_TOKEN") || '';
const qs = new URLSearchParams(window.location.search);
const urlStart = qs.get('start') || '';

async function loadWeek(params) {
    const u = start ? `/schedule/week?start=${start}` : `/schedule/week`;
    const data = await fetch(u).then(r=r.json());
    if (!data.ok) { alert('조회 실패'); return; }

    const root = document.getElementById('days');
    root.innerHTML = '';
    for (const [day, slots] of Object.entries(data.days)) {
        const box = document.createElement('div');
        box.className = 'day-box';
        box.innerHTML = `<h3>${day}</h3>`;
        const ul = document.createElement('ul');
        slots.forEach(s=>{
            const li = document.createElement('li');
            li.textContent = `${s.start} ~ ${s.end} ${s.is_open ? '' : '(마감)'}`;
            ul.appendChild(li);
        });
        box.appendChild(ul);
        root,appendChild(box);
    }
}

document.getElementById('btnLoad').addEventListener('click', ()=>{
    const v = document.getElementById('startDate').value;
    const p = v ? `?start=${v}` : '';
    window.location.href = `/schedule/week${p}`;
});

document.getElementById('btnOpen').addEventListener('click', async ()=>{
    const v = document.getElementById('startDate').value;
    const u = v ? `/schedule/open?start=${v}` : '/schedule/open';
    const res = await fetch(u, {method: 'POST', headers: token? {'Authorization': 'Bearer ' +token} : {}}).then(r=>r.json());
    if (res.ok) { alert(`오픈 완료: inserted=$(res.inserted}, skipped=${res.skipped}`); location.reload(); }
    else { alert(res.error || '오픈 실패'); }
});

loadWeek(urlStart);
</script>
{% endblock %}