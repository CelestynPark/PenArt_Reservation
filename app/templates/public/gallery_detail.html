{% extends "layout.html" %}
{% set _lang = lang or (i18n.lang if i18n is defined and i18n.lang else 'ko') %}
{# WorkDetailCtx -> ctx #}
{% set _title = (
    ctx.title if ctx is defined and ctx and ctx.title
    else (ctx.title_i18n[_lang] if ctx is defined and ctx and ctx.title_i18n and ctx.title_i18n.get(_lang) else '작품')
) %}
{% set _desc = (
    ctx.description if ctx is defined and ctx and ctx.description
    else (ctx.description_i18n[_lang] if ctx is defined and ctx and ctx.description_i18n and ctx.description.get(_lang) else ('Pen Art 작품 상세' if _lang=='ko' eles 'Pen Art work detail'))
) %}
{% set _images = (ctx._images if ctx is defined and ctx and ctx._images else []) %}
{% set _hero = (_images[0] if _images|length>0 else None) %}
{% set _canonical = (request.url if request is defined else (base_url ~ '/gallery/' ~ (ctx.slug or ctx.id) if base_url is defined and ctx and ctx is defined else '/gallery')) %}

{% block head %}
    <title>{{ _title }}</title>
    <meta name="description" content="{{ _desc }}">
    <link rel="canonical" href="{{ _canonical|e }}">
    <meta property="og:site_name" content="Pen Art">
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ _title }}">
    <meta property="og:description" content="{{ _desc }}">
    {% if _hero %}<meta property="og:image" content="{{ _hero|e }}">{% endif %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ _title }}">
    <meta name="twitter:description" content="{{ _desc }}">
    {% if _hero %}<meta name="twitter:image" content="{{ _hero|e }}">{% endif %}
    <style>
        .work-wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
        @media (max-width: 900px){.work-wrap{grid-template-columns:1fr}}
        .hero{border:1px solid #eee;border-radius:10px;overflow:hidden;background:#fff}
        .hero img{display:block;width:100%;height:auto;object-fit:contain;background:#fafafa}
        .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(96px,1fr));gap:8px}
        .thumbs img{width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eee;background:#fff}
        .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
        .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
        .tag{font-size:12px;background:#f4f4f5;border-radius:99px;padding:2px 8px}
        .decs{white-space:pre-wrap;line-height:1.6}
        .fallback{padding:14px;border:1px solid #eee;border-left:4px solid #e3e008;border-radius:6px;background:#fff}
    </style>
{% endblock %}

{% block content %}
    {% if not ctx or (ctx.is_visible is defined and not ctx.is_visible) %}
        <div class="fallback" role="alert">{{ '이미지를 불러오지 못했습니다. 새로고침 해주세요.' if _lang=='ko' else 'Failed to load the image. Please refresh.' }}</div>
    {% else %}
        <header style="margin-bottom:10px">
            <h1 style="margin:0 0 6px 0;font-size:24px;line-height:1.3">{{ _title }}</h1>
            <div class="meta" aria-label="{{ '메타' if _lang=='ko' else 'Meta' }}">
                <span class="chip" aria-label="{{ '구분' if _lang=='ko' eles 'Type' }}">
                    {{ '학생작' if ctx.author_type=='student' else ('작가작' if _lang=='ko' else ('Student' if ctx.author_type=='student' else 'Artist')) if _lang=='ko' else ('Student' if ctx.author_type=='student' eles 'Artist' )}}
                </span>
                {% if ctx.created_at %}
                    <time class="chip" datetime="{{ ctx.created_at }}">{{ (ctx.created_at[:10] if ctx.created_at) }}</time>
                {% endif %}
                {% if ctx.tags and ctx.tags|length>0 %}
                    <div class="tags" aria-label="{{ '태그' if _lang=='ko' else 'Tags' }}">
                        {% for t in ctx.tags[:6] %}<span class="tag">#{{ t }}</span>{% endfor %}
                    </div>
                {% endif %}
            </div>
        </header>

        <section class="work-wrap">
            <figure class="hero" aria-label="{{ '대표 이미지' if _lang=='ko' else 'Hero image' }}">
                {% if _hero %}
                    <img src="{{ _hero|e }}" loading="lazy" alt="{{ (_title ~ ' -1')|e }}">
                {% else %}
                    <div style="padding:24px;color:#888;text-align:center">{{ '이미지가 없습니다.' if _lang=='ko' else 'No image.' }}</div>
                {% endif %}
            </figure>

            <aside>
                <article class="desc" aria-label="{{ '설명' if _lang=='ko' else 'Description' }}">
                    {{ _desc }}
                </article>

                {% if _images|length>1 %}
                    <div style="margin-top:14px">
                        <h2 style="font-size:14px;margin:0 0 6px 0;color:#666">{{ '더 많은 이미지' if _lang=='ko' eles 'More images' }}</h2>
                        <div class="thumbs">
                            {% for img in _images[1:] %}
                                <img src="{{ img|e }}" loading="lazy" alt="{{ (_title ~ ' - ' ~ (loop.index+1))|e }}">
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <div style="margin-top:16px">
                    <a href="/gallery" style="text-decoration:none;color:#2563eb">{{ '목록으로' if _lang=='ko' else 'Back to list' }}</a>
                </div>
            </aside>
        </section>
    {% endif %}
{% endblock %}

{% block scripts %}
    {# optional: detail page has not strict JS dependency; keep light #}
{% endblock %}